name: Reusable Issue Assignment Workflow

on:
  workflow_call:
    inputs:
      issue_number:
        description: 'Issue number'
        required: true
        type: number
      repo_name:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
      issue_labels:
        description: 'Issue labels (JSON array)'
        required: true
        type: string
    secrets:
      GIST_PAT:
        required: true
      DISCORD_BOT_TOKEN:
        required: true

jobs:
  route:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout automation scripts
        uses: actions/checkout@v4
        with:
          repository: aossie/contributor-automation
          path: automation
          
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          pip install -r automation/requirements.txt
          
      - name: Route issue
        id: route
        env:
          ISSUE_LABELS: ${{ inputs.issue_labels }}
        run: |
          cd automation
          python scripts/issue_router.py \
            --issue-labels "$ISSUE_LABELS" \
            --output-file ../routing_decision.json
          
          ROUTE_TO=$(jq -r '.route_to' ../routing_decision.json)
          REASON=$(jq -r '.reason' ../routing_decision.json)
          echo "route_to=$ROUTE_TO" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
          
      - name: Post to Apprentice channel
        if: steps.route.outputs.route_to == 'apprentices'
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          REPO_NAME: ${{ inputs.repo_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          ISSUE_LABELS: ${{ inputs.issue_labels }}
        run: |
          cd automation
          python scripts/discord_manager.py \
            --action announce_good_first_issue \
            --repo-name "$REPO_NAME" \
            --issue-number "$ISSUE_NUMBER" \
            --issue-labels "$ISSUE_LABELS" \
            --bot-token "$DISCORD_BOT_TOKEN"
            
      - name: Find available Sentinel
        if: steps.route.outputs.route_to == 'sentinel'
        id: find_sentinel
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
        run: |
          cd automation
          python scripts/sentinel_assigner.py \
            --action find_available \
            --gist-pat "$GIST_PAT" \
            --output-file ../sentinel_result.json
          
          if [ -f ../sentinel_result.json ]; then
            FOUND=$(jq -r '.found' ../sentinel_result.json)
            if [ "$FOUND" = "true" ]; then
              SENTINEL_USERNAME=$(jq -r '.sentinel_username' ../sentinel_result.json)
              DISCORD_ID=$(jq -r '.discord_id' ../sentinel_result.json)
              echo "found=true" >> $GITHUB_OUTPUT
              echo "sentinel_username=$SENTINEL_USERNAME" >> $GITHUB_OUTPUT
              echo "discord_id=$DISCORD_ID" >> $GITHUB_OUTPUT
            else
              echo "found=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "found=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Escalate to Knights if no Sentinel available
        if: steps.route.outputs.route_to == 'sentinel' && steps.find_sentinel.outputs.found == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          REPO_NAME: ${{ inputs.repo_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          cd automation
          # Add label for Knight attention
          python scripts/issue_router.py \
            --action escalate_to_knights \
            --repo-name "$REPO_NAME" \
            --issue-number "$ISSUE_NUMBER" \
            --github-token "$GITHUB_TOKEN"
          
          # Notify Knights in Discord
          python scripts/discord_manager.py \
            --action alert_knights_no_sentinels \
            --repo-name "$REPO_NAME" \
            --issue-number "$ISSUE_NUMBER" \
            --bot-token "$DISCORD_BOT_TOKEN"
            
      - name: Assign to Sentinel
        if: steps.route.outputs.route_to == 'sentinel' && steps.find_sentinel.outputs.found == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ inputs.repo_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          SENTINEL_USERNAME: ${{ steps.find_sentinel.outputs.sentinel_username }}
        run: |
          cd automation
          python scripts/sentinel_assigner.py \
            --action assign_issue \
            --repo-name "$REPO_NAME" \
            --issue-number "$ISSUE_NUMBER" \
            --sentinel-username "$SENTINEL_USERNAME" \
            --github-token "$GITHUB_TOKEN"
            
      - name: Update Sentinel TOML
        if: steps.route.outputs.route_to == 'sentinel' && steps.find_sentinel.outputs.found == 'true'
        env:
          GIST_PAT: ${{ secrets.GIST_PAT }}
          SENTINEL_USERNAME: ${{ steps.find_sentinel.outputs.sentinel_username }}
          REPO_NAME: ${{ inputs.repo_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          cd automation
          python scripts/gist_manager.py \
            --action assign_issue_to_sentinel \
            --username "$SENTINEL_USERNAME" \
            --repo-name "$REPO_NAME" \
            --issue-number "$ISSUE_NUMBER" \
            --gist-pat "$GIST_PAT"
            
      - name: Add deadline label
        if: steps.route.outputs.route_to == 'sentinel' && steps.find_sentinel.outputs.found == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ inputs.repo_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          cd automation
          python scripts/sentinel_assigner.py \
            --action add_deadline_label \
            --repo-name "$REPO_NAME" \
            --issue-number "$ISSUE_NUMBER" \
            --github-token "$GITHUB_TOKEN"
            
      - name: Notify Sentinel
        if: steps.route.outputs.route_to == 'sentinel' && steps.find_sentinel.outputs.found == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          REPO_NAME: ${{ inputs.repo_name }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
          SENTINEL_USERNAME: ${{ steps.find_sentinel.outputs.sentinel_username }}
          DISCORD_ID: ${{ steps.find_sentinel.outputs.discord_id }}
        run: |
          cd automation
          # Comment on issue
          python scripts/discord_manager.py \
            --action post_assignment_comment \
            --repo-name "$REPO_NAME" \
            --issue-number "$ISSUE_NUMBER" \
            --sentinel-username "$SENTINEL_USERNAME" \
            --github-token "$GITHUB_TOKEN"
          
          # DM on Discord
          python scripts/discord_manager.py \
            --action dm_sentinel_assignment \
            --discord-user-id "$DISCORD_ID" \
            --repo-name "$REPO_NAME" \
            --issue-number "$ISSUE_NUMBER" \
            --bot-token "$DISCORD_BOT_TOKEN"
